* Backup VM

Ситема бекапирования VM, работающих на KVM и работающих на LVM или raw
файлах (формат qcow не оттестирован, также не оттeстированы, но должны
работать бекапы под XEN). Управление и настройка параметра бекапа
происходит централизовано с одной машины (на которую склыдываются
бекапы). Копирование бекапов происходит поверх ssh и сохраняется в lzo.
Бекап производится в несколько потоков. Логгируется информация с
помощью rsyslog (по умолчанию в /var/log/messages).

Чтобы настроить бекапы нужно внести правки в конфигурационный файл
backup_vm.d/backup_vm.conf:
- перечислить сервера виртуализации, на которых хранятся
бекапируемые VM (при этом VM могут быть перемещены на любой из
перечисленных гипервизеров без потери функциональности бекапа этой
VM), - параметр HostServers
- указать папку на локальном сервере бекапа, в которую будут
сложены бекапы - BackupStorage
- указать время, когда будут производиться бекапы - BackupHours.
Обратите внимание, это интервал времени запуска бекапа, бекапы могут
завершаться вне этого интервала.
- в зависимости от производительности бекап сервера указать
максимальное число VM, которые будут бекапиться одновременно -
MaxBackupThreads.
- указать максимальное число бекапов VM, запускаемых одновременно на одном
гипервизоре - MaxBackupThreadsForHost. Если по расписанию на гипервизор
настроено, например, 10 бекапов, а MaxBackupThreadsForHost=2, то одновременно на
гипервизоре будет работать не более 2-х бекапов.
 
Расписание бекапа виртуальных машин задается в файле
backup_vm.d/sheduler.conf. Для каждой VM указываются:
- дни недели, в которые должен быть снят бекап
- число одновременно хранимых бекапов
- необходимость сохранения одного (последнего) бекапа на гипервизоре
Для каждой VM задаются параметры бекапа в фале vmsnapshot.d/VM_NAME,
где VM_NAME - имя VM на гипервизоре:
- холодный (с выключением VM) или горячий (с сохранением состояния RAM)
бекап
- путь на гипервизоре, необходимый для выполнения бекапа (убедитесь,
что по этому пути достаточно места для сохранения одной копии бекапа
каждой VM)
- для VM на нескольких LVM можно указать исключения LVM из бекапа
Если файла vmsnapshot.d/VM_NAME не существует используется дефолтный
конфиг vmsnapshot.d/default. 

Чтобы автоматически запускать бекапы, необходимо настроить
авторизацию по ssh-ключу от пользователя сервера бекапа до
пользователя root на гипервизорах и добавить на бекап-сервере в крон
задание:
	*/10 * * * * /path/to/vm_backup_sheduler
Для запуска бекапа в ручном режиме нужно убедиться, что существует
файл vm в vmsnapshot.d, и имеется строчка о бекапе в sheduler.conf и запустить
	./backup_vm name
вывод работы будут направлены в stdout и stderr. Для запуска в фоновом режиме
нужно перенаправить все потоков ввода-выввода, т.к. иначе происходит 
зависание (http://en.wikipedia.org/wiki/Nohup):
	./backup_vm name &>backup.log </dev/null


Замечания:
- горячий бекап возможен только для VM на LVM, в противном случае
не зависимо от настроек будет запущен холодный бекап
- downtime виртуальной машины будет минимальный, если все виртуальные
диски созданы на LVM, так как и при холодном, и при горячем бекапе
используются системa LVM снэпшотов

Зависимости:
- необходим пакет lzop на всех гипервизорах и сервере бекапа
- необходимо установить параметр kernel.sysrq=1 в sysctl.conf на всех VM
для возможности сброса кеша диска при горячем бекапе

